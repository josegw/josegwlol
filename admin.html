<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Admin Panel - josegw.lol</title>
<style>
  /* Reset y básicos */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #0e0e10;
    color: #eee;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  header {
    background: #18191c;
    padding: 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  header h1 {
    margin: 0;
    font-weight: 700;
    font-size: 1.5rem;
  }

  /* Hamburguer Menu */
  .hamburger {
    cursor: pointer;
    width: 25px;
    height: 20px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .hamburger span {
    display: block;
    height: 3px;
    background: #5865F2;
    border-radius: 2px;
  }

  nav {
    background: #18191c;
    width: 220px;
    position: fixed;
    top: 0;
    left: -220px;
    height: 100vh;
    padding-top: 60px;
    transition: left 0.3s ease;
    overflow-y: auto;
    z-index: 10;
  }
  nav.open {
    left: 0;
  }
  nav ul {
    list-style: none;
    padding: 0 1rem;
    margin: 0;
  }
  nav ul li {
    margin-bottom: 1rem;
  }
  nav ul li button {
    width: 100%;
    padding: 0.7rem 1rem;
    background: #5865F2;
    border: none;
    border-radius: 5px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    text-align: left;
    transition: background-color 0.2s;
  }
  nav ul li button:hover {
    background: #4752c4;
  }

  main {
    flex-grow: 1;
    padding: 1.5rem;
    margin-left: 0;
    transition: margin-left 0.3s ease;
  }
  main.shifted {
    margin-left: 220px;
  }

  section {
    margin-bottom: 2rem;
  }
  section h2 {
    margin-top: 0;
    margin-bottom: 1rem;
    border-bottom: 2px solid #5865F2;
    padding-bottom: 0.3rem;
  }
  p {
    font-size: 1rem;
    margin: 0.3rem 0;
  }

  /* Botones funcionales */
  button.action-btn {
    background: #43b581;
    border: none;
    padding: 0.6rem 1rem;
    border-radius: 6px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  button.action-btn:hover {
    background: #369d6b;
  }

  /* Login container */
  #login-section {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  #login-section button {
    background-color: #5865F2;
    border: none;
    color: white;
    padding: 14px 28px;
    font-size: 1.1rem;
    border-radius: 10px;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  #login-section button:hover {
    background-color: #4752c4;
  }

  /* Responsive */
  @media (max-width: 600px) {
    nav {
      width: 180px;
      left: -180px;
    }
    main.shifted {
      margin-left: 180px;
    }
  }
</style>
</head>
<body>

<header>
  <h1>Admin Panel</h1>
  <div class="hamburger" id="hamburger" aria-label="Toggle menu" role="button" tabindex="0">
    <span></span><span></span><span></span>
  </div>
</header>

<nav id="menu">
  <ul>
    <li><button id="btn-uptime">Ver Uptime</button></li>
    <li><button id="btn-latency">Ping Backend</button></li>
    <li><button id="btn-info">Info Sistema</button></li>
    <li><button id="btn-restart">Reiniciar Backend</button></li>
    <li><button id="btn-logout">Cerrar Sesión</button></li>
  </ul>
</nav>

<main id="main-content">
  <div id="login-section">
    <button id="login-btn">Iniciar sesión con Discord</button>
  </div>

  <div id="admin-section" style="display:none;">
    <section id="uptime-section" style="display:none;">
      <h2>Uptime del servidor</h2>
      <p id="uptime-text">Cargando...</p>
    </section>

    <section id="latency-section" style="display:none;">
      <h2>Ping al backend</h2>
      <p id="latency-text">Cargando...</p>
    </section>

    <section id="info-section" style="display:none;">
      <h2>Información del sistema</h2>
      <pre id="info-text" style="white-space: pre-wrap; background:#1a1a1a; padding:1rem; border-radius:6px; max-height:300px; overflow-y:auto;"></pre>
    </section>

    <section id="restart-section" style="display:none;">
      <h2>Reiniciar Backend</h2>
      <button class="action-btn" id="restart-btn">Reiniciar Ahora</button>
      <p id="restart-msg"></p>
    </section>
  </div>
</main>

<script>
  const CLIENT_ID = "1378952738360131604";
  const REDIRECT_URI = "https://josegw.lol/admin.html"; // o admin si tienes rewrite
  const ADMIN_ID = "1307562402958676048";
  const BACKEND_URL = "https://josegwlol-backend.onrender.com";

  const loginSection = document.getElementById("login-section");
  const adminSection = document.getElementById("admin-section");
  const hamburger = document.getElementById("hamburger");
  const menu = document.getElementById("menu");
  const mainContent = document.getElementById("main-content");

  // Toggle menu hamburguesa
  function toggleMenu() {
    menu.classList.toggle("open");
    mainContent.classList.toggle("shifted");
  }
  hamburger.addEventListener("click", toggleMenu);
  hamburger.addEventListener("keydown", e => {
    if(e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      toggleMenu();
    }
  });

  // Parse URL code param from Discord OAuth2 redirect
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get("code");

  async function exchangeCodeForToken(code) {
    // Exchange code for token via backend (proxy)
    const response = await fetch(`${BACKEND_URL}/oauth/token`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ code, redirect_uri: REDIRECT_URI })
    });
    return response.json();
  }

  async function getUserInfo(token) {
    // Get user info from backend proxy
    const response = await fetch(`${BACKEND_URL}/oauth/userinfo`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    return response.json();
  }

  async function init() {
    if (!code) {
      loginSection.style.display = "flex";
      adminSection.style.display = "none";
      return;
    }

    try {
      // 1. Exchange code for token
      const tokenData = await exchangeCodeForToken(code);
      if (!tokenData.access_token) {
        throw new Error("Token no recibido");
      }

      // 2. Get user info
      const userInfo = await getUserInfo(tokenData.access_token);
      if (userInfo.id !== ADMIN_ID) {
        alert("No tienes permiso para acceder.");
        window.history.replaceState({}, document.title, "/admin.html");
        loginSection.style.display = "flex";
        adminSection.style.display = "none";
        return;
      }

      // Usuario autorizado
      loginSection.style.display = "none";
      adminSection.style.display = "block";

      // Limpiar URL del código para evitar reuso
      window.history.replaceState({}, document.title, "/admin.html");

      // Carga inicial de datos
      showUptime();
      showLatency();
      showInfo();

      // Mostrar secciones
      document.getElementById("uptime-section").style.display = "block";
      document.getElementById("latency-section").style.display = "block";
      document.getElementById("info-section").style.display = "block";
      document.getElementById("restart-section").style.display = "block";

    } catch (error) {
      alert("Error en autenticación: " + error.message);
      loginSection.style.display = "flex";
      adminSection.style.display = "none";
    }
  }

  async function showUptime() {
    const res = await fetch(`${BACKEND_URL}/uptime`);
    const data = await res.json();
    document.getElementById("uptime-text").textContent = `Tiempo activo: ${data.uptime}`;
  }

  async function showLatency() {
    const start = performance.now();
    await fetch(`${BACKEND_URL}/ping`);
    const end = performance.now();
    const latency = (end - start).toFixed(2);
    document.getElementById("latency-text").textContent = `Latencia: ${latency} ms`;
  }

  async function showInfo() {
    const res = await fetch(`${BACKEND_URL}/info`);
    const data = await res.json();
    document.getElementById("info-text").textContent = JSON.stringify(data, null, 2);
  }

  async function restartBackend() {
    if(!confirm("¿Seguro que quieres reiniciar el backend?")) return;
    const res = await fetch(`${BACKEND_URL}/restart`, { method: "POST" });
    if(res.ok) {
      document.getElementById("restart-msg").textContent = "¡Backend reiniciado con éxito!";
    } else {
      document.getElementById("restart-msg").textContent = "Error al reiniciar backend.";
    }
  }

  // Botones
  document.getElementById("login-btn").addEventListener("click", () => {
    const discordAuthURL = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=code&scope=identify`;
    window.location.href = discordAuthURL;
  });
  document.getElementById("btn-uptime").addEventListener("click", showUptime);
  document.getElementById("btn-latency").addEventListener("click", showLatency);
  document.getElementById("btn-info").addEventListener("click", showInfo);
  document.getElementById("btn-restart").addEventListener("click", restartBackend);
  document.getElementById("btn-logout").addEventListener("click", () => {
    // Borra código de la URL y recarga
    window.history.replaceState({}, document.title, "/admin.html");
    location.reload();
  });

  init();
</script>

</body>
</html>
