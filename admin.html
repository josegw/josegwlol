<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Panel Admin Funcional</title>
<style>
  body { background: #121214; color: white; font-family: Arial, sans-serif; margin: 0; padding: 0; }
  header { background: #232329; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
  button { background: #5865F2; border: none; padding: 10px 15px; color: white; border-radius: 6px; cursor: pointer; }
  button:hover { background: #4752c4; }
  nav { background: #2a2a2f; padding: 10px 20px; display: flex; gap: 15px; flex-wrap: wrap; }
  nav button { flex: 1 1 150px; }
  main { padding: 20px; }
  section { margin-bottom: 20px; }
  .info-box { background: #1f1f23; padding: 15px; border-radius: 8px; }
  textarea { width: 100%; padding: 8px; border-radius: 6px; border: none; resize: vertical; }
  pre { background: #222; padding: 10px; border-radius: 6px; max-height: 150px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;}
</style>
</head>
<body>

<header>
  <h1>Panel Admin</h1>
  <button id="logout-btn">Cerrar sesión</button>
</header>

<nav>
  <button id="btn-info">Información Servidor</button>
  <button id="btn-users">Usuarios Conectados</button>
  <button id="btn-logs">Logs</button>
  <button id="btn-sendmsg">Enviar Mensaje</button>
  <button id="btn-restart">Reiniciar Servidor</button>
</nav>

<main>
  <section id="info-section" style="display:none;">
    <h2>Información del Servidor</h2>
    <div class="info-box" id="server-info">Cargando...</div>
  </section>

  <section id="users-section" style="display:none;">
    <h2>Usuarios Conectados</h2>
    <div class="info-box" id="user-list">Cargando...</div>
  </section>

  <section id="logs-section" style="display:none;">
    <h2>Logs</h2>
    <pre id="logs-content">Cargando...</pre>
    <button id="download-logs">Descargar logs</button>
  </section>

  <section id="sendmsg-section" style="display:none;">
    <h2>Enviar Mensaje Global</h2>
    <textarea id="message-input" rows="4" placeholder="Escribe el mensaje aquí..."></textarea><br/>
    <button id="send-message-btn">Enviar Mensaje</button>
    <div id="sendmsg-result"></div>
  </section>

  <section id="restart-section" style="display:none;">
    <h2>Reiniciar Servidor</h2>
    <button id="restart-btn" style="background:#c0392b;">Reiniciar Ahora</button>
    <div id="restart-result"></div>
  </section>
</main>

<script>
  const BACKEND_URL = "http://localhost:10000"; // Cambia aquí si tu backend está en otro dominio/puerto

  // Manejo simple de logout (limpiar tokens y redirigir o recargar)
  document.getElementById("logout-btn").addEventListener("click", () => {
    localStorage.clear();
    alert("Sesión cerrada.");
    // Recarga o redirige a login si tienes
    location.reload();
  });

  // Mostrar sólo la sección indicada y ocultar las demás
  function showSection(id) {
    const sections = ["info-section","users-section","logs-section","sendmsg-section","restart-section"];
    sections.forEach(sec => {
      document.getElementById(sec).style.display = (sec === id) ? "block" : "none";
    });
  }

  // Fetch y mostrar info servidor
  async function loadServerInfo() {
    const div = document.getElementById("server-info");
    div.textContent = "Cargando...";
    try {
      const res = await fetch(BACKEND_URL + "/api/admin-info");
      if (!res.ok) throw new Error("Error al obtener info servidor");
      const data = await res.json();
      div.innerHTML = `
        <b>Uptime:</b> ${data.uptimeSeconds} segundos<br/>
        <b>Memoria RSS:</b> ${data.memory.rssMB} MB<br/>
        <b>Heap Usado:</b> ${data.memory.heapUsedMB} MB<br/>
        <b>CPUs:</b> ${data.cpuCount}<br/>
        <b>Hora Servidor:</b> ${new Date(data.serverTime).toLocaleString()}<br/>
        <b>Versión Node.js:</b> ${data.nodeVersion}
      `;
    } catch (e) {
      div.textContent = "Error al cargar información del servidor.";
      console.error(e);
    }
  }

  // Fetch y mostrar usuarios conectados
  async function loadUsers() {
    const div = document.getElementById("user-list");
    div.textContent = "Cargando...";
    try {
      const res = await fetch(BACKEND_URL + "/api/users");
      if (!res.ok) throw new Error("Error al obtener usuarios");
      const data = await res.json();
      if (data.users.length === 0) {
        div.textContent = "No hay usuarios conectados.";
        return;
      }
      div.innerHTML = data.users.map(u => `<div><b>${u.username}</b> (ID: ${u.id}) - Estado: ${u.status}</div>`).join("");
    } catch (e) {
      div.textContent = "Error al cargar usuarios.";
      console.error(e);
    }
  }

  // Fetch y mostrar logs
  async function loadLogs() {
    const pre = document.getElementById("logs-content");
    pre.textContent = "Cargando...";
    try {
      const res = await fetch(BACKEND_URL + "/api/logs");
      if (!res.ok) throw new Error("Error al obtener logs");
      const data = await res.json();
      pre.textContent = data.logs.join("\n");
    } catch (e) {
      pre.textContent = "Error al cargar logs.";
      console.error(e);
    }
  }

  // Descargar logs
  document.getElementById("download-logs").addEventListener("click", () => {
    fetch(BACKEND_URL + "/api/logs")
      .then(res => res.json())
      .then(data => {
        const blob = new Blob([data.logs.join("\n")], {type: "text/plain"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `logs-${Date.now()}.txt`;
        a.click();
        URL.revokeObjectURL(url);
      });
  });

  // Enviar mensaje global
  document.getElementById("send-message-btn").addEventListener("click", async () => {
    const msg = document.getElementById("message-input").value.trim();
    const resDiv = document.getElementById("sendmsg-result");
    resDiv.textContent = "";
    if (!msg) {
      resDiv.textContent = "El mensaje no puede estar vacío.";
      return;
    }
    try {
      const res = await fetch(BACKEND_URL + "/api/send-message", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: msg }),
      });
      const data = await res.json();
      if (res.ok) {
        resDiv.textContent = data.message;
        document.getElementById("message-input").value = "";
      } else {
        resDiv.textContent = "Error: " + (data.error || "Error desconocido");
      }
    } catch (e) {
      resDiv.textContent = "Error enviando mensaje.";
      console.error(e);
    }
  });

  // Reiniciar servidor
  document.getElementById("restart-btn").addEventListener("click", async () => {
    const resDiv = document.getElementById("restart-result");
    resDiv.textContent = "Reiniciando servidor...";
    try {
      const res = await fetch(BACKEND_URL + "/api/restart", { method: "POST" });
      const data = await res.json();
      if (res.ok) {
        resDiv.textContent = data.message;
      } else {
        resDiv.textContent = "Error: " + (data.error || "Error desconocido");
      }
    } catch (e) {
      resDiv.textContent = "Error al reiniciar servidor.";
      console.error(e);
    }
  });

  // Eventos botones menú
  document.getElementById("btn-info").addEventListener("click", () => {
    showSection("info-section");
    loadServerInfo();
  });
  document.getElementById("btn-users").addEventListener("click", () => {
    showSection("users-section");
    loadUsers();
  });
  document.getElementById("btn-logs").addEventListener("click", () => {
    showSection("logs-section");
    loadLogs();
  });
  document.getElementById("btn-sendmsg").addEventListener("click", () => {
    showSection("sendmsg-section");
  });
  document.getElementById("btn-restart").addEventListener("click", () => {
    showSection("restart-section");
  });

  // Inicio: mostrar info servidor por defecto
  showSection("info-section");
  loadServerInfo();
</script>

</body>
</html>
